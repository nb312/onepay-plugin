# OnePay超详细调试手册

## 📖 概述

OnePay插件现在具备了超详细的调试记录功能，类似本地调试器，能够记录每个方法调用、条件判断（if语句）、变量赋值等详细信息。您可以在WordPress后台直接查看这些调试信息，无需查看代码。

## 🎯 调试功能特点

### 1. 超详细记录
- ✅ **方法进入/退出**: 记录每个方法的调用和返回
- ✅ **条件判断**: 记录所有if语句的条件和结果
- ✅ **变量变化**: 记录变量赋值和值的变化
- ✅ **执行时间**: 记录每个步骤的耗时
- ✅ **内存使用**: 记录内存占用情况
- ✅ **错误追踪**: 详细记录错误和异常
- ✅ **调用栈**: 记录方法调用的层级关系

### 2. 实时监控
- 📊 所有回调处理过程实时记录
- 🔍 支持按会话、请求、类型筛选
- ⏱️ 精确到微秒的时间戳
- 💾 自动持久化到数据库

## 🛠️ 后台查看界面

### 访问路径
WordPress后台 → WooCommerce → **OnePay超详细调试**

### 页面功能

#### 1. 📊 概览页面
- **总记录数**: 显示记录的总数量
- **总会话数**: 显示调试会话数量
- **活跃天数**: 显示记录活跃的天数
- **类型分布**: 显示各种记录类型的统计

#### 2. 📋 会话列表
- **会话ID**: 每次请求的唯一标识
- **开始/结束时间**: 请求处理的时间范围
- **记录数**: 该会话的调试记录总数
- **错误数**: 该会话中的错误数量
- **查看详情**: 点击可查看该会话的详细记录

#### 3. 🔍 详细记录查看
- **时间线视图**: 按时间顺序显示所有记录
- **层级显示**: 根据方法调用深度缩进显示
- **类型筛选**: 可按记录类型筛选（方法、条件、变量等）
- **搜索功能**: 支持关键词搜索
- **数据展开**: 点击可查看详细的变量数据

## 📋 记录类型说明

### 🔗 请求级别
- **request_start**: 请求开始，记录初始参数
- **request_end**: 请求结束，记录最终结果

### 🎯 方法级别
- **method_enter**: 进入方法，记录参数和上下文
- **method_exit**: 退出方法，记录返回值和耗时

### 🔀 逻辑级别
- **condition**: 条件判断，记录if语句的条件和结果
- **variable**: 变量赋值，记录变量名、值和类型

### 🐞 调试级别
- **debug**: 调试信息，记录关键步骤说明
- **error**: 错误记录，记录异常和错误详情

### 🌐 网络级别
- **http_request**: HTTP请求，记录API调用详情

## 📖 使用示例

### 1. 查看回调处理过程

1. 发送一个测试回调到您的网站
2. 进入 **OnePay超详细调试** 页面
3. 在会话列表中找到最新的记录
4. 点击 **查看详情** 查看完整处理过程

### 2. 调试签名验证问题

在详细记录中您可以看到：
```
🔍 [条件判断] empty($this->gateway->platform_public_key) = false
📋 数据详情:
{
  "public_key_length": 1234,
  "public_key_preview": "-----BEGIN PUBLIC KEY-----..."
}

🎯 [进入方法] OnePay_Callback::verify_callback_signature()
📋 参数:
{
  "callback_data_keys": ["merchantNo", "result", "sign"],
  "callback_id": 123
}

📝 [变量赋值] $result_data = "{"code":"0000","message":"SUCCESS"...}"
📝 [变量赋值] $signature_data = "base64_encoded_signature..."

🔍 [条件判断] $signature_valid = true
```

### 3. 分析性能问题

在记录中查看：
- **execution_time**: 每个方法的执行时间
- **memory_usage**: 内存使用情况
- **total_processing_time**: 总处理时间

### 4. 错误排查

错误记录会显示：
- **错误消息**: 具体的错误描述
- **错误代码**: 错误编号（如果有）
- **上下文数据**: 错误发生时的变量状态
- **调用栈**: 错误发生的代码路径

## ⚙️ 配置选项

### 启用调试记录
在 **WooCommerce设置 → 支付 → OnePay** 中：
- 开启 **调试模式** 选项
- 保存设置

### 数据管理
- **自动清理**: 系统会自动清理7天前的记录
- **手动清理**: 在调试页面点击"清理旧记录"按钮
- **存储位置**: 记录保存在数据库表 `wp_onepay_detailed_debug_records`

## 🔧 故障排除指南

### 问题1: 没有看到调试记录
**解决方案:**
1. 确认已开启调试模式
2. 检查数据库表是否创建成功
3. 确认有回调请求发送到网站

### 问题2: 记录太多导致页面加载慢
**解决方案:**
1. 使用筛选功能缩小查看范围
2. 定期清理旧记录
3. 只在需要时开启调试模式

### 问题3: 某些记录看不到详细数据
**解决方案:**
1. 点击"数据详情"展开查看
2. 检查是否有权限访问
3. 确认记录没有被截断

## 📊 数据结构说明

### 核心字段
- **session_id**: 会话标识符
- **request_id**: 请求标识符  
- **timestamp**: 精确时间戳
- **record_type**: 记录类型
- **execution_depth**: 执行深度
- **message**: 记录消息
- **variable_data**: 变量数据（JSON格式）
- **condition_data**: 条件数据（JSON格式）

### 变量数据格式
```json
{
  "name": "变量名",
  "type": "变量类型",
  "value": "变量值",
  "description": "描述信息",
  "size": "数据大小"
}
```

### 条件数据格式
```json
{
  "condition": "条件表达式",
  "result": true,
  "variables": {
    "相关变量": "变量值"
  }
}
```

## 🚀 最佳实践

### 1. 调试流程
1. **开启调试** → 在设置中启用调试模式
2. **触发问题** → 发送测试回调或重现问题
3. **查看记录** → 在后台查看详细调试信息
4. **分析问题** → 根据记录分析问题原因
5. **关闭调试** → 问题解决后关闭调试模式

### 2. 性能优化
- 只在需要时开启调试模式
- 定期清理旧的调试记录
- 使用筛选功能精确查看需要的记录

### 3. 安全考虑
- 调试记录可能包含敏感信息
- 生产环境使用后及时关闭调试
- 定期清理包含敏感数据的记录

## 📞 技术支持

如果您在使用调试功能时遇到问题：
1. 查看本手册的故障排除部分
2. 检查WordPress错误日志
3. 确认插件版本是否最新
4. 联系技术支持并提供调试记录

---

**注意**: 此调试功能会产生大量数据，建议只在需要排查问题时启用，平时保持关闭状态以优化性能。